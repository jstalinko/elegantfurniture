function w(b){const h=b.utils.escapeRE,A=b.utils.arrayReplaceAt,k=" \r\n$+<=>^`|~",x=b.utils.lib.ucmicro.P.source,v=b.utils.lib.ucmicro.Z.source;function C(e,t,_,g){let r,n=e.bMarks[t]+e.tShift[t];const o=e.eMarks[t];if(n+2>=o||e.src.charCodeAt(n++)!==42||e.src.charCodeAt(n++)!==91)return!1;const a=n;for(;n<o;n++){const c=e.src.charCodeAt(n);if(c===91)return!1;if(c===93){r=n;break}else c===92&&n++}if(r<0||e.src.charCodeAt(r+1)!==58)return!1;if(g)return!0;const i=e.src.slice(a,r).replace(/\\(.)/g,"$1"),u=e.src.slice(r+2,o).trim();return i.length===0||u.length===0?!1:(e.env.abbreviations||(e.env.abbreviations={}),typeof e.env.abbreviations[":"+i]>"u"&&(e.env.abbreviations[":"+i]=u),e.line=t+1,!0)}function R(e){const t=e.tokens;if(!e.env.abbreviations)return;const _=new RegExp("(?:"+Object.keys(e.env.abbreviations).map(function(n){return n.substr(1)}).sort(function(n,o){return o.length-n.length}).map(h).join("|")+")"),g="(^|"+x+"|"+v+"|["+k.split("").map(h).join("")+"])("+Object.keys(e.env.abbreviations).map(function(n){return n.substr(1)}).sort(function(n,o){return o.length-n.length}).map(h).join("|")+")($|"+x+"|"+v+"|["+k.split("").map(h).join("")+"])",r=new RegExp(g,"g");for(let n=0,o=t.length;n<o;n++){if(t[n].type!=="inline")continue;let a=t[n].children;for(let i=a.length-1;i>=0;i--){const u=a[i];if(u.type!=="text")continue;let c=0;const f=u.content;r.lastIndex=0;const s=[];if(!_.test(f))continue;let l;for(;l=r.exec(f);){if(l.index>0||l[1].length>0){const E=new e.Token("text","",0);E.content=f.slice(c,l.index+l[1].length),s.push(E)}const p=new e.Token("abbr_open","abbr",1);p.attrs=[["title",e.env.abbreviations[":"+l[2]]]],s.push(p);const d=new e.Token("text","",0);d.content=l[2],s.push(d);const T=new e.Token("abbr_close","abbr",-1);s.push(T),r.lastIndex-=l[3].length,c=r.lastIndex}if(s.length){if(c<f.length){const p=new e.Token("text","",0);p.content=f.slice(c),s.push(p)}t[n].children=a=A(a,i,s)}}}}b.block.ruler.before("reference","abbr_def",C,{alt:["paragraph","reference"]}),b.core.ruler.after("linkify","abbr_replace",R)}export{w as a};
